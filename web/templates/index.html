<html>
	<head>
		<title>Keep</title>
		<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/index.css') }}">
		<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/add_new.css') }}">
		<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/yesnodialog.css') }}">
		<link href="https://parsleyjs.org/src/parsley.css" rel="stylesheet" />
		<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	</head>
<style>
</style>
<script type="text/javascript">
	generateKeepTable();

	function filterBySearch() {
		var td, i, tdArr, j;
		var input = $("#searchInput")[0];
		var filter = input.value.toUpperCase();
		var table = $("#keeptable")[0];
		var tr = table.getElementsByTagName("tr");

		// Loop through all table rows
		for (i = 1; i < tr.length; i++) {
			tdArr = tr[i].getElementsByTagName("td");
			// Loop through all table columns in the current row, and hide those who don't match the search query
			var found = false;
			for (j = 0; j < tdArr.length; j++) {
				td = tdArr[j];
				if (td) {
					if (td.textContent.toUpperCase().indexOf(filter) > -1 ) {
						found = true;
						break;
					}
				}
			}

			if (found) {
				tr[i].style.display = "";
			} else {
				tr[i].style.display = "none";
			}
		}
	}

	function onAddNewEntryFormSubmit(){
		var data = {
			
			"name": $('[name="input-name"]')[0].value,
			"link": $('[name="input-link"]')[0].value,
			"tags": $('[name="input-tags"]')[0].value,
			"pwd": $('[name="input-pwd"]')[0].value
		}

		$.ajax({
			type: 'POST',
			url: '/keep/api/v1/new_entry' + name,
			data: JSON.stringify(data),
			contentType: "application/json; charset=utf-8",
			dataType: "json",
			success: function(resp) {
				if(resp.data === "created") {
					generateKeepTable();
				}
			},
			error: function() {
				console.log('error');
			}
		});

		$("#actual-registration-form")[0].reset();
		addNewDialogClose();

		return false;
	}

	function addNewDialogOpen() {
		$("#add_new_entry_modal")[0].style.display = "block";
		var span = $("#add-new-close-button")[0];
		span.onclick = addNewDialogClose;
	}

	function addNewDialogClose() {
		$("#actual-registration-form")[0].reset();
		$("#add_new_entry_modal")[0].style.display = "none";
	}

	function confirmDeleteDialogOpen(glyph) {
		glyphToDelete = glyph;
		var name = $(glyphToDelete).closest('tr')[0].cells[0].innerText;
		$("#name-to-confirm-delete")[0].innerText = "'" + name + "'";
		$("#confirm_delete_modal")[0].style.display = "block";
	}

	function confirmDeleteDialogCloseNo() {
		$("#confirm_delete_modal")[0].style.display = "none";
	}

	function confirmDeleteDialogCloseYes() {
		var name = $(glyphToDelete).closest('tr')[0].cells[0].innerText;

		$.ajax({
			type: 'DELETE',
			url: '/keep/api/v1/rm?name=' + name,
			success: function(resp) {
				if (resp.data === "deleted") {
					$("#confirm_delete_modal")[0].style.display = "none";
					generateKeepTable();
				}
			},
			error: function() {
			}
		});
		
	}

	function generateKeepTable() {
		$.ajax({
			type: 'GET',
			url: '/keep/api/v1/ll',
			success: function(resp) {
				var table_data = resp.data;
				var mytable = $("#keeptable")[0];
				var newTblBody = document.createElement("tbody");

				// delete existing rows
				var count = $('#keeptable tr').length;
				for(var i=1; i<count; i++) {
					mytable.deleteRow(1);
				}

				// insert new rows
				for(var i=0; i<table_data.length; i++) {
					row = mytable.insertRow(-1);
					var cell = row.insertCell(-1);
					cell.innerHTML = table_data[i].name;
					var cell = row.insertCell(-1);
					cell.innerHTML = table_data[i].tags;
					var cell = row.insertCell(-1);
					cell.innerHTML = '<a href="' + table_data[i].link + '" target="_blank" rel="noopener noreferrer">'+ table_data[i].link + '</a>';
					var cell = row.insertCell(-1);
					cell.innerHTML = '<div class="button" id="button-5" onclick="return false"><div id="translate"></div><a href="#">edit</a></div>';
					cell.innerHTML = '<span style="font-size: 2em; color: Grey;">\
							<i class="fa fa-trash" onclick="confirmDeleteDialogOpen(this)" title="delete"></i>\
						</span>\
						<span style="font-size: 2.1em; color: Grey;">\
							<i class="fa fa-edit" onclick="editEntryDialogOpen(this)" title="edit"></i>\
						</span>\
						<span style="font-size: 2em; color: Grey;">\
							<i class="fa fa-copy" onclick="copy(this)" title="copy"></i>\
						</span>';
				}
			},
			error: function() {
			}
		});
	}
	
	function copy(glyph) {
		var name = $(glyph).closest('tr')[0].cells[0].innerText;
		$.ajax({
			type: 'GET',
			url: '/keep/api/v1/cp?name=' + name,
			success: function(resp) {
				glyph.style.color = '#00ff00';
				glyph.onmouseover = function(){};
				glyph.onmouseout = function(){};

				setTimeout(function() { 
					glyph.style.color = 'grey';
					glyph.onmouseover = function() {
						glyph.style.color = 'seagreen';
					}
					glyph.onmouseout = function() {
						glyph.style.color = 'grey';
					}
					}, 3000);
			},
			error: function() {
			}
		});
	}

	function editEntryDialogOpen(glyph) {
		var aTableRow = $(glyph).closest('tr')[0];

		var formElements = $("#edit-entry-modal-form")[0].elements;
		formElements["input-name"].value = aTableRow.cells[0].innerText;
		formElements["input-tags"].value = aTableRow.cells[1].innerText;
		formElements["input-link"].value = aTableRow.cells[2].innerText;

		$("#edit_entry_modal")[0].style.display = "block";
		$("#edit-entry-close-button")[0].onclick = editEntryDialogClose;
	}

	function editEntryDialogClose() {
		$("#edit-entry-modal-form")[0].reset();
		$("#edit_entry_modal")[0].style.display = "none";
	}

	function onEditEntryModalFormSubmit() {
		var formElements = $("#edit-entry-modal-form")[0].elements;
		var data = {
			"name": formElements["input-name"].value,
			"link": formElements["input-tags"].value,
			"tags": formElements["input-link"].value,
			"pwd": formElements["input-pwd"].value
		}

		$.ajax({
			type: 'PUT',
			url: '/keep/api/v1/update_entry' + name,
			data: JSON.stringify(data),
			contentType: "application/json; charset=utf-8",
			dataType: "json",
			success: function(resp) {
				console.log('success');
				if(resp.data === "updated") {
					generateKeepTable();
				}
			},
			error: function() {
				console.log('error');
			}
		});
		editEntryDialogClose();
		return false;
	}

	</script>
	<body>
		<h1><span class="lightblue">the</span> <span class="darkgreen">Keep</span></h1>
		<div class="button-action button-action-positive" id="new_entry_button" title="add new entry" onclick="addNewDialogOpen()">
			<a href="#">new</a>
		</div>

		<!-- modal add_new -->
		<div id="add_new_entry_modal" class="modal">
			<div class="modal-content">
				<span class="close" id="add-new-close-button">&times;</span>
				<div id="registration-form">
				<div class='fieldset'>
					<legend><span class="lightblue">new</span> <span class="darkgreen">Entry</span></legend>
					<form id="actual-registration-form" onsubmit="return onAddNewEntryFormSubmit()" class="form-container" autocomplete="off">
						<div class='row'>
							<label for='input-name'>name</label>
							<input type="text" class="form-control" required placeholder="name..." name="input-name" id="input-name">
						</div>
						<div class='row'>
							<label for="input-link">link</label>
							<input type="text" class="form-control" required placeholder="link..." name="input-link" id="input-link">
						</div>
						<div class='row'>
							<label for="input-tags">tags</label>
							<input type="text" placeholder="short comma separated tags (e.g mac,hw,news)" name="input-tags" id="input-tags">
						</div>
						<div class='row'>
							<label for="input-pwd">password</label>
							<input type="password" class="form-control" placeholder="type 'random' for a randomly generated password" name="input-pwd" id="input-pwd" required>
						</div>
						<input type="submit" value="save">
					</form>
				</div>
			</div>
			</div>
		</div>
		<!-- end modal add_new -->

		<!-- modal confirm delete -->
		<div id="confirm_delete_modal" class="modal">
			<div class="yesno-dialog">
				<h2>confirm <span style="color:#FB667A">delete?</span></h2>
				<h3 id="name-to-confirm-delete"></h3>
				<br/>
				<div class="button-no" id="button-no" onclick="confirmDeleteDialogCloseNo()">
					<a href="#" style="color:red">no</a>
				</div>
				<div class="button-yes" id="button-yes" onclick="confirmDeleteDialogCloseYes()">
					<a href="#" style="color:seagreen">yes</a>
				</div>
				<br/>
				<br/>
			</div>
		</div>
		<!-- end modal confirm delete -->

		<!-- modal edit record -->
		<div id="edit_entry_modal" class="modal">
			<div class="modal-content">
				<span class="close" id="edit-entry-close-button">&times;</span>
				<div id="registration-form">
				<div class='fieldset'>
					<legend><span class="lightblue">edit</span> <span class="darkgreen">Entry</span></legend>
					<form id="edit-entry-modal-form" onsubmit="return onEditEntryModalFormSubmit()" class="form-container" autocomplete="off">
						<div class='row'>
							<label for='input-name'>name</label>
							<input type="text" class="form-control" required placeholder="name..." name="input-name" id="input-name" disabled>
						</div>
						<div class='row'>
							<label for="input-link">link</label>
							<input type="text" class="form-control" required placeholder="link..." name="input-link" id="input-link">
						</div>
						<div class='row'>
							<label for="input-tags">tags</label>
							<input type="text" placeholder="short comma separated tags (e.g mac,hw,news)" name="input-tags" id="input-tags">
						</div>
						<div class='row'>
							<label for="input-pwd">password</label>
							<input type="password" class="form-control" placeholder="leave this empty if you don't want to change it" name="input-pwd" id="input-pwd">
						</div>
						<input type="submit" value="save">
					</form>
				</div>
			</div>
			</div>
		</div>
		<!-- end modal edit record -->

		<br/>
		<br/>
		<!-- search bar -->

		<input type="text" id="searchInput" onkeyup="filterBySearch()" placeholder="search here..." title="type in a name" autocomplete="off">

		<!-- end search bar -->

		<!-- keep table -->
		<table id="keeptable" class="container">
			<thead>
				<tr>
					<th style="width:10%"><h1>name</h1></th>
					<th style="width:15%"><h1>tags</h1></th>
					<th style="width:65%"><h1>link</h1></th>
					<th style="width:10%"><h1/>actions</th>
				</tr>
			</thead>
		</table>
		<!-- end keep table -->
	</body>
</html>
